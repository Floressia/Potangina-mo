;/*FB_PKG_DELIM*/

__d("ReStoreEARSetupFailure",[],(function(a,b,c,d,e,f){"use strict";var g="Encryption keychain could not be setup",h="ReStoreEARSetupFailure";a=function(a){babelHelpers.inheritsLoose(b,a);function b(b){var c;b=g+": "+b;c=a.call(this,b)||this;c.message=b;c.name=h;return c}return b}(babelHelpers.wrapNativeSuper(Error));f.ERROR_MESSAGE=g;f.ERROR_NAME=h;f.ReStoreEARSetupFailure=a}),66);
__d("ReStoreEncryptionFailure",[],(function(a,b,c,d,e,f){"use strict";var g="ReStoreEncryptionFailure";a=function(a){babelHelpers.inheritsLoose(b,a);function b(b,c){var d;b=b+" - Encrypted Restore was unable to encrypt an entity for table "+c;d=a.call(this,b)||this;d.message=b;d.name=g;d.tableName=c;return d}return b}(babelHelpers.wrapNativeSuper(Error));f.ERROR_NAME=g;f.ReStoreEncryptionFailure=a}),66);
__d("createReStoreIndexedDbPersistence",["BrowserLockManager","ClientConsistency","CurrentMessengerUser","Deferred","ExecutionEnvironment","FBLogger","LSPlatformErrorChannel","MAWCryptoConsts","MAWExceededStorageQuota","MAWKeychainNaClCrypto","MWBroadcastChannel","MWEARKeychainV3","MessengerLocksManagerFallback","ODS","ReStoreBinaryEncoding","ReStoreDbClosedError","ReStoreDbConfigStore","ReStoreDbVersionChange","ReStoreDecryptionFailure","ReStoreEARSetupFailure","ReStoreEncryptionFailure","ReStoreErrorAction","ReStoreIndexeddbPersistenceInitFailure","ReStorePersistence","ReStoreTabNotifier","clearTimeout","cr:2649","cr:4038","gkx","justknobx","nullthrows","pageID","promiseDone","promiseFromRequest","qex","recoverableViolation","setTimeout","tweetnacl","unrecoverableViolation","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=d("CurrentMessengerUser").getIDorEIMU(),k=4096,l=new Set([d("ReStoreDbConfigStore").CONFIG_STORE_NAME]),m=new(d("ReStoreBinaryEncoding").Encoder)(),n=new(d("ReStoreBinaryEncoding").Decoder)();function o(a,e,f){if(a==null){a===null&&c("FBLogger")("mpf_web_foundations").mustfix("Attempting to decrypt null. This should never happen",String((i||(i=c("ExecutionEnvironment"))).isInWorker));return a}var g=new Uint8Array(a);try{g=g[1];var h=b("cr:2649")!=null?b("cr:2649").getDbEncryptionKey(g):d("MWEARKeychainV3").getDbEncryptionKey(g);h=h.key;var j=3;a=d("tweetnacl").secretbox.open(new Uint8Array(a,j+d("tweetnacl").secretbox.nonceLength),new Uint8Array(a,j,d("tweetnacl").secretbox.nonceLength),new Uint8Array(h));if(a==null){throw new(d("MAWKeychainNaClCrypto").EARDecryptionError)("ReStore was unable to decrypt an entity. Attempting to use key version : "+((j=g)!=null?j:"non-provided")+".")}return n.decode(a)}catch(a){f(a);c("LSPlatformErrorChannel").emit(new(d("ReStoreDecryptionFailure").ReStoreDecryptionFailure)(a.message,e));throw new(d("ReStoreDecryptionFailure").ReStoreDecryptionFailure)(a.message,e)}}function p(a,c){try{var e=b("cr:2649")!=null?b("cr:2649").getDbEncryptionKey():d("MWEARKeychainV3").getDbEncryptionKey(),f=e.key;e=e.version;e=new Uint8Array([0,e,d("MAWCryptoConsts").CIPHER_ID]);var g=d("tweetnacl").randomBytes(d("tweetnacl").secretbox.nonceLength);a=d("tweetnacl").secretbox(m.encode(a),g,new Uint8Array(f));f=new Uint8Array(e.length+g.length+a.length);f.set(e);f.set(g,e.length);f.set(a,e.length+g.length);return f.buffer}catch(a){throw new(d("ReStoreEncryptionFailure").ReStoreEncryptionFailure)(a.message,c)}}function q(a){for(a of a.values())if(a.size!==0)return!1;return!0}function r(a,b){var c=[];a=new Set(a);for(var d of a)b.objectStoreNames.contains(d)||c.push(d);d=[];for(var e=0;e<b.objectStoreNames.length;e++){var f=b.objectStoreNames[e];!a.has(f)&&!l.has(f)&&d.push(f)}if(c.length!==0||d.length!==0)return[c,d]}function s(a,b,c,d){d===void 0&&(d={});if(c==null){b.debug("Schema doesn't have changes to apply");return}b.debug("Schema has changes to apply");b=c[0];c=c[1];b.forEach(function(b){a.objectStoreNames.contains(b)||(d[b]!=null?d[b](a):a.createObjectStore(b,{autoIncrement:!0}))});c.forEach(function(b){a.objectStoreNames.contains(b)&&a.deleteObjectStore(b)})}function t(a,b,e,f,g,h){function j(a){e(a.target),g.debug("DB onversionchange TABID="+c("pageID")),c("FBLogger")("mpf_web_foundations").info("[pdb] onversionchange inWorker=%s",String((i||(i=c("ExecutionEnvironment"))).isInWorker)),f.endFail("version_change"),c("LSPlatformErrorChannel").emit(new(d("ReStoreDbVersionChange").ReStoreDbVersionChange)())}return new Promise(function(e,g){var i=indexedDB.open(a,h),k=c("gkx")("23664")?c("setTimeout")(function(){f.addPoint("pdb_open_timeout"),g(new(d("ReStoreIndexeddbPersistenceInitFailure").ReStoreIndexeddbPersistenceInitFailure)())},13e3):void 0;i.onupgradeneeded=function(a){a=a.target;var d=a.result;a=a.transaction;c("clearTimeout")(k);b(d,a)};i.onerror=function(a){c("clearTimeout")(k),f.endFail("failed_to_open_pdb"),g(c("unrecoverableViolation")("Failed to open db","messenger_web_product",{error:a.target.error}))};i.onsuccess=function(a){a=a.target.result;c("clearTimeout")(k);a.addEventListener("versionchange",j);e(a)}})}async function u(a,b,d){a=a.objectStore(b);if(!("getAll"in a)||!("getAllKeys"in a))return new Map();var e=await c("promiseFromRequest")(a.getAllKeys());e=e.length>d?e[e.length-d]:void 0;e=e!=null?IDBKeyRange.lowerBound(e,!1):void 0;a=await Promise.all([c("promiseFromRequest")(a.getAllKeys(e,d)),c("promiseFromRequest")(a.getAll(e,d))]);e=a[0];d=a[1];if(e.length!==d.length){c("recoverableViolation")("Error pre-caching "+b+" IDB table","messenger_web_product");return new Map()}a=new Map();for(b=0;b<e.length;++b)a.set(e[b],{status:"encrypted",value:d[b]});return a}async function v(a,b,d){var e;d.addPoint("cache_start");var f=(e=c("qex")._("338"))!=null?e:100;try{e=Array.from(a.objectStoreNames).filter(function(a){return!a.startsWith("_")});var g=a.transaction([].concat(e),"readonly");await Promise.all(e.map(async function(a){var c=await u(g,a,f);b.set(a,c)}));d.addPoint("cache_end")}catch(a){c("recoverableViolation")("Error initting ReStore cache","messenger_web_product",{error:a}),d.addPoint("cache_failed"),b.clear()}return a}async function w(a,e,f,g,h,j){var k=b("cr:2649")==null?e:[].concat(e,[b("cr:2649").EAR_STORE_NAME]),l=b("cr:2649")==null?{}:(e={},e[b("cr:2649").EAR_STORE_NAME]=b("cr:2649").createEARStore,e),m;if(b("cr:2649")!=null)try{h.addPoint("generate_ear_key_default_start"),m=await b("cr:2649").generateKeyWithDefaultVersion(),h.addPoint("generate_ear_key_default_end")}catch(a){h.addPoint("generate_ear_key_default_failed"),c("FBLogger")("mpf_web_foundations").catching(a).mustfix("EAR generateKeyWithDefaultVersion failed")}function n(c,a){h.addAnnotations({bool:{dbEmpty:!0}});d("ReStoreDbConfigStore").createDbConfig(c,g.defaultConfig);for(var e of k)l[e]!=null?l[e](c):c.createObjectStore(e,{autoIncrement:!0});if(m!=null&&b("cr:2649")!=null){c=m;e=c.version;c=babelHelpers.objectWithoutPropertiesLoose(c,["version"]);b("cr:2649").storeEARKey(a,e,c)}}h.addPoint("idb_open_start");e=await t(a,n,f,h,j);h.addPoint("idb_open_end");var o=e.transaction(d("ReStoreDbConfigStore").CONFIG_STORE_NAME,"readonly");o=await Promise.all([d("ReStoreDbConfigStore").detectConfigMismatch(o,g),d("ReStoreDbConfigStore").readCorruptionFailuresFromConfig(o).then(function(a){return(a=a==null?void 0:a.value)!=null?a:0})]);var p=o[0];o=o[1];var q=o>0;q&&(c("FBLogger")("mpf_web_foundations").info("[pdb] opening corrupted db failures=%s inWorker=%s",String(o),String((i||(i=c("ExecutionEnvironment"))).isInWorker)),j.debug("DB corrupted, deleting db"));p&&j.debug("DB config mismatch, deleting db");h.addAnnotations({bool:{configMismatch:p,dbCorruptionOccured:q}});if(p||q)e.close(),h.addPoint("delete_db_start"),await c("promiseFromRequest")(indexedDB.deleteDatabase(a)),h.addPoint("delete_db_end"),h.addPoint("reopen_db_start"),e=await t(a,n,f,h,j),h.addPoint("reopen_db_end");else{var u=r(k,e),v=b("cr:2649")!=null?await b("cr:2649").generateEARKey(e):null;(u!=null||v!=null)&&(j.debug("Schema mismatch, bumping db version"),e.close(),h.addPoint("mismatch_start"),e=await t(a,function(a,c){s(a,j,u,l);if(v!=null&&b("cr:2649")!=null){a=v.version;var d=babelHelpers.objectWithoutPropertiesLoose(v,["version"]);b("cr:2649").storeEARKey(c,a,d)}},f,h,j,e.version+1),h.addPoint("mismatch_end"))}if(b("cr:2649")!=null)try{h.addPoint("ear_keys_init_start"),await b("cr:2649").initEAR(e),h.addPoint("ear_keys_init_end")}catch(b){h.addPoint("ear_keys_init_failed"),e.close(),c("FBLogger")("mpf_web_foundations").catching(b).mustfix("EAR failed to init as part of ReStore"),c("promiseDone")(c("promiseFromRequest")(indexedDB.deleteDatabase(a)),function(a){},function(a){return c("FBLogger")("mpf_web_foundations").catching(a).warn("Failed to delete DB")}),c("LSPlatformErrorChannel").emit(new(d("ReStoreEARSetupFailure").ReStoreEARSetupFailure)("Failed to setup EAR in Restore"))}return e}function a(a,e,f,g){var l=g.logHistory,m=g.transactionLockQplLogger,n=g.userFlow,r=j+"-"+a,s="dbLock-"+r,u=!0,x,y=[],z=null,A=!1,B=b("cr:4038")!=null&&c("BrowserLockManager")!=null?new(b("cr:4038").RestoreConcurrencyManager)({onLockAcquired:async function(){if(!u)return;var a=await K(!1);D!==a&&D!=null&&(E.clear(),c("FBLogger")("mpf_web_foundations").info("[pdb] cache dropped, out of date cache version"));A=!0;D=a},onLockReleased:function(){A=!1;return Promise.resolve()}}):null;l.debug("PDB is ON");n.addPoint("init_idb_start");g="mwChat-flushchanges-"+j+"-"+a;var C=d("MWBroadcastChannel").MWBroadcastChannel(g),D=void 0,E=new Map(),F=c("nullthrows")((g=c("BrowserLockManager"))!=null?g:c("MessengerLocksManagerFallback")(c("uuidv4")().toString())),G=new Promise(function(b,d){var g=m.startTracking(!0,void 0,s);g.addAnnotations({string:{source:"createReStoreIndexedDbPersistence",type:"initDB"}});g.mark("lock_requested");c("promiseDone")(F.request(s,async function(){g.mark("lock_granted");try{var h=await w(a,e,H,f,n,l);g.mark("db_initialized");C.addEventListener("message",N);b(h);g.end()}catch(a){d(a),c("FBLogger")("mpf_web_foundations").catching(a).warn("[pdb] dbLock initDB issue"),g.fail()}}),function(a){g.end()},function(a){c("FBLogger")("mpf_web_foundations").catching(a).warn("[pdb] dbLock idbPromise issue"),g.fail()})});c("promiseDone")(G.then(function(){n.addPoint("init_idb_end")}));c("qex")._("403")&&c("promiseDone")(R(function(){return G.then(function(a){return v(a,E,n)})},"readonly"));function H(a){a.close(),u=!1,B==null?void 0:B.release(),C.removeEventListener("message",N)}function I(a,b,c){c=a.transaction(c!=null&&c.length>0?c:a.objectStoreNames,b,{durability:"relaxed"});d("MAWExceededStorageQuota").listenToQuotaExceededError(c);return c}function J(a){var b=E.get(a);b==null&&(b=new Map(),E.set(a,b));return b}async function K(a){return(a=await M(function(a){return c("promiseFromRequest")(a.objectStore(d("ReStoreDbConfigStore").CONFIG_STORE_NAME).get(d("ReStoreDbConfigStore").CACHE_VERSION_KEY))},"readonly",a))==null?void 0:a.value}function L(){if(z)return;z=new Promise(async function(a){var b;try{var d=async function(){if(x==null){var a;b=(a=b)!=null?a:await G;var d=I(b,y.some(function(a){return a.writemode==="readwrite"||a.expectingWrite})?"readwrite":"readonly");d.onabort=function(){x===d&&(x=null)};x=d}var e=x;a=[];for(var f of y){if(f.writemode==="readwrite"){e.mode==="readwrite"&&a.push(f);x=null;break}a.push(f)}y.splice(0,a.length);a.length&&await Promise.all(a.map(function(a){a=a.thunk;return a(e)}));c("gkx")("116")&&!y.length&&x!=null&&await c("promiseFromRequest")(x.objectStore(x.objectStoreNames[0]).get(""))};while(y.length)await d();(d=x)==null?void 0:d.commit==null?void 0:d.commit()}finally{x=null,a(),z=null}})}function M(a,b,c){c===void 0&&(c=!1);return new Promise(function(d,e){y.push({expectingWrite:c,thunk:async function(b){var c;try{c=await a(b)}catch(a){e(a);return}d(c)},writemode:b}),L()})}function N(a){a=a.data;var b=a.changeSet,d=a.fromVersion,e=a.sentinelDeleted;a=a.toVersion;if(A){c("FBLogger")("mpf_web_foundations").info("[pdb] unexpected cache update received after verifying cache matches db, ignoring");return}D!==d&&D!=null&&(E.clear(),c("FBLogger")("mpf_web_foundations").info("[pdb] out of order cache update received"));D=a;b.forEach(function(a,b){var c=J(b);a.forEach(function(a,b){a===e?c.delete(b):c.set(b,{status:"decrypted",value:a})})})}function O(){if(!u)return;c("promiseDone")(G,async function(a){var b;a=I(a,"readwrite");b=(b=(b=await d("ReStoreDbConfigStore").readCorruptionFailuresFromConfig(a))==null?void 0:b.value)!=null?b:0;await d("ReStoreDbConfigStore").writeCorruptionFailuresToConfig(a,b)})}function P(){c("promiseDone")(G,function(a){H(a)})}function Q(){if(!u)throw new(c("ReStoreDbClosedError"))()}async function R(a,b){await G;c("gkx")("23661")&&Q();if(c("gkx")("23662")&&c("justknobx")._("1699")){var e=c("ClientConsistency").getAdditionalRevisions();e.size>0&&(c("FBLogger")("mpf_web_foundations").info("[pdb] js mismatch detected"),d("ReStoreErrorAction").softRefresh())}return B!=null?B.runExclusively(a):new Promise(function(d,e){var f=m.startTracking(!0,void 0,s);f.addAnnotations({string:{source:"createReStoreIndexedDbPersistence",type:"runExclusivelyLock"}});f.mark("lock_requested");c("promiseDone")(F.request(s,async function(){f.mark("lock_granted");try{var g=await K(c("gkx")("116")?b==="readwrite":!1);f.mark("cache_version_read");D!==g&&D!=null&&(f.mark("cache_clearing"),E.clear(),c("FBLogger")("mpf_web_foundations").info("[pdb] cache dropped, out of date cache version"),f.mark("cache_cleared"));D=g;A=!0;g=await a();A=!1;d(g);f.end()}catch(a){A=!1,e(a),f.fail()}}),function(a){f.end()},function(a){f.fail()})})}async function S(b,e){e=e.upgrade;if(!u)return;var f=c("uuidv4")(),g=c("nullthrows")(D);async function h(a){var e=new Promise(function(e,h){a.oncomplete=function(a){try{C.postMessage({changeSet:b,fromVersion:g,sentinelDeleted:d("ReStorePersistence").sentinelDeleted,toVersion:f})}catch(a){c("recoverableViolation")("Failed to broadcast changes","messenger_web_product",a)}e(a.target.result)},a.onerror=a.onabort=function(a){D=null,E.clear(),h(a)}}),h=!1;for(var i of b){var j=i[0],k=i[1],l=a.objectStore(j);for(k of k){var m=k[0],n=k[1],o;if(n===d("ReStorePersistence").sentinelDeleted)o=l.delete(m);else{n=p(n,j);o=l.put(n,m)}o.onerror=function(){return h=!0}}}await c("promiseFromRequest")(a.objectStore(d("ReStoreDbConfigStore").CONFIG_STORE_NAME).put({name:d("ReStoreDbConfigStore").CACHE_VERSION_KEY,value:f}));h?a.abort():a.commit!=null&&a.commit();await e}function i(){Array.from(b).forEach(function(a){var b=a[0];a=a[1];var c=J(b);Array.from(a).forEach(function(a){var b=a[0];a=a[1];a===d("ReStorePersistence").sentinelDeleted?c.delete(b):c.set(b,{status:"decrypted",value:a})})}),D=f}if(q(b))return;var j=await G;if(e===!0){c("FBLogger")("mpf_web_foundations").info("[pdb] Updating IDB version, fromVersion: %s, non-empty tables: %s",j.version,Array.from(b.entries()).filter(function(a){a[0];a=a[1];return a.size>0}).map(function(a){a=a[0];return a}).sort().toString());await z;(e=x)==null?void 0:e.abort();x=null;j.close();E.clear();D=null;G=async function(){var b=new(c("Deferred"))(),d=await t(a,function(a,d){i(),c("promiseDone")(h(d),function(){b.resolve()},function(a){c("FBLogger")("mpf_web_foundations").catching(a).warn("Failed to complete db flush"),b.reject()})},H,n,l,j.version+1);await b.getPromise();return d}();await G;return}if(b.size===0)return;i();e=function(){var a=Array.from(b.keys());a.push(d("ReStoreDbConfigStore").CONFIG_STORE_NAME);if(c("gkx")("116"))return M(function(a){return h(a)},"readwrite");else return h(I(j,"readwrite",a))};if(B!=null)return B.queueFlush(e);else await e()}function T(){(c("gkx")("23663")||c("gkx")("23664"))&&c("promiseDone")(G,function(b){H(b);b=indexedDB.deleteDatabase(a);b.onerror=function(){(h||(h=d("ODS"))).bumpEntityKey(3185,"db_delete","error.persistence"),c("recoverableViolation")("[pdb] Failed to delete db","messenger_web_product")};b.onblocked=function(){(h||(h=d("ODS"))).bumpEntityKey(3185,"db_delete","block.persistence")};b.onsuccess=function(){(h||(h=d("ODS"))).bumpEntityKey(3185,"db_delete","success.persistence")}})}return{clearCache:function(){E.clear()},close:P,flush:S,get:function(a,b,d){try{var e=J(b);if(e.has(d)){a=e.get(d);if((a==null?void 0:a.status)==="encrypted"){var f=o(a.value,b,T);e.set(d,{status:"decrypted",value:f});return f}return a==null?void 0:a.value}else{if(!u)return new Promise(function(){});var g=M(function(a){return c("promiseFromRequest")(a.objectStore(b).get(d))},"readonly").then(function(a){var c=e.get(d);if((c==null?void 0:c.value)!==g)return c==null?void 0:c.value;c=o(a,b,T);e.set(d,{status:"decrypted",value:c});return c});e.set(d,{status:"pending",value:g});return g}}catch(a){c("FBLogger")("mpf_web_foundations").catching(a).warn("Error occurs in indexeddb persistence get");throw a}},isClosed:function(){return!u},isPersistenceSupported:async function(){try{await G;return!0}catch(a){return!1}},logError:function(a,b,d,e){if(d==="dbCorruption"){b==="readwrite"&&O();throw c("FBLogger")("mpf_web_foundations").mustfixThrow("Got unexpected undefined in pdb, mode: %s, table: %s, id: %s, deletedInThisTxn: %s",b,a,(d=e==null?void 0:e.id)!=null?d:"",(b=e==null?void 0:e.deletedInThisTxn)!=null?b:"")}},queueCommitWork:function(a){return B!=null?Promise.resolve(B.queueFlush(a)):a()},runExclusively:R,shouldApplySync:function(){return!0},shouldInline:function(a,b){return d("ReStoreBinaryEncoding").estimateSize(b)<k},shouldSync:function(a,b){return a==="notifyInMemoryTable"?!1:!0},tabTablesNotifier:function(){var a="restore-table-"+r;a=(i||(i=c("ExecutionEnvironment"))).isInBrowser?c("ReStoreTabNotifier")(a):void 0;return a},types:["indexeddb"],uniqueId:r}}a.schemaDiff=r;a.applyChanges=s;g.default=a}),98);
__d("sum",[],(function(a,b,c,d,e,f){function a(a){var b=0;for(var a=a,c=Array.isArray(a),d=0,a=c?a:a[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var e;if(c){if(d>=a.length)break;e=a[d++]}else{d=a.next();if(d.done)break;e=d.value}e=e;b+=e}return b}f["default"]=a}),66);
__d("LSDBRestoreConfig",["ReStoreDbConfigStore","gkx","justknobx","sum"],(function(a,b,c,d,e,f,g){"use strict";e=c("gkx")("24149");f=c("justknobx")._("347");function a(){var a=2,b=c("sum")([c("gkx")("23664")?1:0,c("gkx")("1251")?1:0]);return a+b}var h={localVersion:a(),name:d("ReStoreDbConfigStore").DB_CONFIG_KEY,serverVersion:f,vaulting:e};function b(){return{defaultConfig:h,isEqual:function(a){return(a==null?void 0:a.localVersion)==null?!1:(a==null?void 0:a.localVersion)===h.localVersion&&(a==null?void 0:a.vaulting)===h.vaulting&&(a==null?void 0:a.serverVersion)===h.serverVersion}}}g.createConfig=b}),98);
__d("migratePDBTablesToEBSM",["EBSMProperties","FBLogger","LSDBRestoreConfig","LSMetadata","LSPlatformLsInitLog","LSReStoreQplLogger","LSReStoreWrapper","MAWLSVaultingHooks","MWLSIndexedDBName","MessengerLogHistory","ODS","Promise","asyncToGeneratorRuntime","clearTimeout","createReStoreIndexedDbPersistence","err","qpl","setTimeout"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(indexedDB==null)return;var e=d("MWLSIndexedDBName").dbName();if(indexedDB.databases!=null){var f=(yield indexedDB.databases());if(f.find(function(a){return a.name===e})==null)return}else{var g;f=(yield (i||(i=b("Promise"))).race([new i(function(a,b){var d=indexedDB.open(e);d.onupgradeneeded=function(b){b.target.transaction.abort(),a(!1)};d.onsuccess=function(b){b.target.result.close(),a(!0)};d.onerror=function(a){b(c("err")("pdb migration error in checking db existance "+((a=a.target)==null?void 0:(a=a.error)==null?void 0:a.message)))}}),new i(function(a,b){g=c("setTimeout")(function(){b(c("err")("pdb db is not available. resolving on timeout"))},300)})]));c("clearTimeout")(g);if(f===!1)return}try{f=c("createReStoreIndexedDbPersistence")(e,Object.keys(d("LSMetadata").metadata.tableIds).map(function(a){return d("LSMetadata").metadata.tableIds[Number(a)].name}),d("LSDBRestoreConfig").createConfig(),{logHistory:d("MessengerLogHistory").getInstance("db_init"),transactionLockQplLogger:d("LSReStoreQplLogger").createQplLogger(c("qpl")._(25303045,"817")),userFlow:d("LSPlatformLsInitLog").lsInitLogger});var j=d("LSReStoreWrapper").createLSReStore(f,d("LSMetadata").metadata,[c("MAWLSVaultingHooks")]);yield a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){for(var b=0;b<c("EBSMProperties").persistedTablesArray.length;b++){var d=c("EBSMProperties").persistedTablesArray[b],e=j.table(d).entries(new WeakMap()),f=(yield e.next());while(!f.done){var g=f.value;g[0];g=g[1];yield a[d].put(g);f=(yield e.next())}}});return function(b){return a.apply(this,arguments)}}(),"readwrite");j.closeDb==null?void 0:j.closeDb();(h||(h=d("ODS"))).bumpEntityKey(3185,"pdb_to_ebsm_migration","migration.success")}catch(a){(h||(h=d("ODS"))).bumpEntityKey(3185,"pdb_to_ebsm_migration","migration.fail");throw a}});return k.apply(this,arguments)}function l(){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=d("MWLSIndexedDBName").dbName();if(indexedDB.databases!=null){var c=(yield indexedDB.databases());if(c.find(function(b){return b.name===a})==null)return}return new(i||(i=b("Promise")))(function(b,c){var d=indexedDB.deleteDatabase(a);d.onsuccess=b;d.onerror=c})});return m.apply(this,arguments)}function a(a){return j(a)["catch"](function(a){c("FBLogger")("messenger_web_product").catching(a).mustfix("Error migrating data from PDB to EBSM")}).then(function(){return l()})["catch"](function(a){c("FBLogger")("messenger_web_product").catching(a).mustfix("Error cleaning up data in PDB post EBSM startup.")})}g["default"]=a}),98);